<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Billetera Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importar Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos personalizados y animaciones */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .transaction-item, #chart-container {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Clases para modo oscuro */
        .dark .dark\:bg-gray-900 { background-color: #111827; }
        .dark .dark\:bg-gray-800 { background-color: #1F2937; }
        .dark .dark\:bg-gray-700 { background-color: #374151; }
        .dark .dark\:text-white { color: #ffffff; }
        .dark .dark\:text-gray-300 { color: #D1D5DB; }
        .dark .dark\:border-gray-700 { border-color: #374151; }
        .dark .dark\:placeholder-gray-400::placeholder { color: #9CA3B0; }
        .dark .dark\:chart-legend-text { color: #D1D5DB; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

    <!-- Pantalla de Carga/Autenticación -->
    <div id="auth-screen" class="flex flex-col items-center justify-center min-h-screen p-4 text-center">
        <svg class="w-16 h-16 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25-2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m12 0V9" />
        </svg>
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Mi Billetera Digital</h1>
        <p class="text-gray-600 dark:text-gray-300 mt-2 mb-8">Inicia sesión para administrar tus finanzas.</p>
        <button id="google-login-btn" class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-white font-semibold py-2 px-6 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.519-3.444-11.01-8.169l-6.571 4.819C9.656 40.663 16.318 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.599 36.372 48 30.651 48 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
            <span>Iniciar sesión con Google</span>
        </button>
    </div>

    <!-- Contenido Principal de la Aplicación -->
    <div id="app-screen" class="hidden max-w-2xl mx-auto">
        <header class="p-4 sm:p-6 flex justify-between items-center">
            <div>
                 <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Resumen Financiero</h1>
                 <p id="user-info" class="text-sm text-gray-500 dark:text-gray-400 mt-1 truncate"></p>
            </div>
            <button id="sign-out-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                Cerrar Sesión
            </button>
        </header>

        <main class="px-4 sm:px-6 pb-24">
            <!-- Tarjeta de Balance -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-300">Balance Actual</p>
                        <p id="balance" class="text-4xl font-bold text-gray-800 dark:text-white mt-1">$0.00</p>
                    </div>
                    <div id="weekly-suggestion-wrapper" class="text-right hidden">
                         <p class="text-sm text-gray-500 dark:text-gray-300">Sugerido Semanal</p>
                         <p id="total-weekly-suggestion" class="text-2xl font-bold text-green-500 mt-1">$0.00</p>
                    </div>
                </div>
                <div class="flex justify-between mt-4 text-sm pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div>
                        <p class="text-gray-500 dark:text-gray-300">Ingresos</p>
                        <p id="total-income" class="font-semibold text-green-500 text-lg">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-500 dark:text-gray-300">Egresos</p>
                        <p id="total-expenses" class="font-semibold text-red-500 text-lg">$0.00</p>
                    </div>
                </div>
            </div>

            <!-- Sección de Cuentas -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Cuentas</h2>
                    <button id="add-account-btn" class="flex items-center gap-1 text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        <span>Nueva</span>
                    </button>
                </div>
                <div id="accounts-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <p id="no-accounts" class="col-span-full text-center text-gray-500 dark:text-gray-400 py-4">Crea tu primera cuenta para empezar.</p>
                </div>
            </div>
            
            <!-- Sección de Análisis Gráfico -->
            <div id="chart-section" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-6 hidden">
                 <div class="flex justify-between items-center mb-4">
                     <h2 class="text-xl font-bold text-gray-800 dark:text-white">Análisis</h2>
                     <div class="flex rounded-lg bg-gray-100 dark:bg-gray-700 p-1">
                         <button id="show-expenses-chart" class="px-3 py-1 text-sm font-semibold rounded-md text-white bg-blue-600">Egresos</button>
                         <button id="show-income-chart" class="px-3 py-1 text-sm font-semibold rounded-md text-gray-600 dark:text-gray-300">Ingresos</button>
                     </div>
                 </div>
                 <div id="chart-container" class="relative h-64">
                     <canvas id="category-chart"></canvas>
                     <p id="no-chart-data" class="absolute inset-0 flex items-center justify-center text-gray-500 dark:text-gray-400 hidden">No hay datos para mostrar</p>
                 </div>
            </div>

            <!-- Lista de Transacciones -->
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Transacciones Recientes</h2>
            <div id="transactions-list" class="space-y-3">
                <p id="no-transactions" class="text-center text-gray-500 dark:text-gray-400 py-8">¡Aún no hay transacciones! Agrega una para empezar.</p>
            </div>
        </main>

        <!-- Botón Flotante -->
        <button id="add-transaction-btn" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-transform transform hover:scale-110">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
        </button>
    </div>

    <!-- Modal para Agregar/Editar Transacción -->
    <div id="transaction-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md mx-auto p-6 z-10 transform scale-95">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Nueva Transacción</h2>
            <form id="transaction-form">
                <div class="flex gap-4 mb-4">
                    <label class="flex-1">
                        <input type="radio" name="type" value="expense" class="sr-only peer" checked>
                        <div class="p-3 text-center rounded-lg border-2 border-gray-300 peer-checked:border-red-500 peer-checked:text-red-600 dark:peer-checked:text-red-400 dark:border-gray-600 dark:peer-checked:border-red-500 cursor-pointer">
                            <span class="font-semibold">Egreso</span>
                        </div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="type" value="income" class="sr-only peer">
                        <div class="p-3 text-center rounded-lg border-2 border-gray-300 peer-checked:border-green-500 peer-checked:text-green-600 dark:peer-checked:text-green-400 dark:border-gray-600 dark:peer-checked:border-green-500 cursor-pointer">
                            <span class="font-semibold">Ingreso</span>
                        </div>
                    </label>
                </div>
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descripción</label>
                    <input type="text" id="description" name="description" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Ej: Café, Salario, Renta">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monto</label>
                        <input type="number" id="amount" name="amount" min="0.01" step="0.01" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="0.00">
                    </div>
                    <div>
                        <label for="account" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cuenta</label>
                        <select id="account" name="account" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></select>
                    </div>
                </div>
                 <div class="mb-4">
                    <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Categoría</label>
                    <select id="category" name="category" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></select>
                </div>
                <div id="edit-date-section" class="hidden mb-4">
                     <label for="transaction-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha de Transacción</label>
                     <input type="date" id="transaction-date" name="transactionDate" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                </div>
                <div id="defer-section" class="hidden mb-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="defer-expense-checkbox" name="deferExpense" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Diferir gasto a meses</span>
                    </label>
                    <div id="defer-options" class="hidden mt-2">
                        <label for="defer-months" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Número de meses</label>
                        <select id="defer-months" name="deferMonths" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                            <option value="3">3 Meses</option> <option value="6">6 Meses</option> <option value="9">9 Meses</option> <option value="12">12 Meses</option> <option value="18">18 Meses</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button type="button" id="cancel-btn" class="w-full py-3 px-4 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold rounded-lg">Cancelar</button>
                    <button type="submit" id="submit-btn" class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Agregar/Editar Cuenta -->
    <div id="account-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md mx-auto p-6 z-10 transform scale-95">
            <h2 id="account-modal-title" class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Nueva Cuenta</h2>
            <form id="account-form">
                <div class="mb-4">
                    <label for="account-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre</label>
                    <input type="text" id="account-name" name="accountName" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Ej: Banco Principal">
                </div>
                <div class="mb-4">
                     <label for="account-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo</label>
                     <select id="account-type" name="accountType" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                         <option value="Efectivo">💵 Efectivo</option> <option value="Débito">💳 Débito</option> <option value="Crédito">🏦 Crédito</option>
                         <option value="Ahorros">💰 Ahorros</option> <option value="Préstamos">🤝 Préstamos</option> <option value="Apartados">📦 Apartados</option>
                     </select>
                </div>
                <div id="extra-fields-section" class="hidden space-y-4 mb-4">
                    <div id="credit-limit-wrapper" class="hidden">
                        <label for="account-credit-limit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Límite de Crédito</label>
                        <input type="number" id="account-credit-limit" name="creditLimit" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="10000.00" min="0" step="0.01">
                    </div>
                    <div id="loan-fields-wrapper" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="account-loan-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monto Préstamo</label>
                                <input type="number" id="account-loan-amount" name="initialLoanAmount" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="50000.00" min="0" step="0.01">
                            </div>
                            <div>
                                <label for="account-loan-months" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Meses a Pagar</label>
                                <input type="number" id="account-loan-months" name="loanMonths" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="12" min="1">
                            </div>
                        </div>
                        <div>
                             <label for="account-start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha de Inicio</label>
                             <input type="date" id="account-start-date" name="startDate" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div id="cut-off-day-wrapper" class="hidden">
                            <label for="account-cut-off-day" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Día de Corte</label>
                            <input type="number" id="account-cut-off-day" name="cutOffDay" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="1-31" min="1" max="31">
                        </div>
                         <div id="payment-day-wrapper" class="hidden">
                            <label for="account-payment-day" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Día de Pago</label>
                            <input type="number" id="account-payment-day" name="paymentDay" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="1-31" min="1" max="31">
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button type="button" id="account-delete-btn" class="hidden w-auto py-3 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Eliminar</button>
                    <button type="button" id="account-cancel-btn" class="flex-grow py-3 px-4 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold rounded-lg">Cancelar</button>
                    <button type="submit" id="account-submit-btn" class="flex-grow py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmación para Eliminar -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm mx-auto p-6 z-10 transform scale-95">
             <h2 id="confirm-title" class="text-lg font-bold text-gray-800 dark:text-white">Confirmar Eliminación</h2>
             <p id="confirm-message" class="text-sm text-gray-600 dark:text-gray-300 mt-2 mb-6">¿Estás seguro?</p>
             <div id="confirm-standard-buttons" class="flex gap-4">
                 <button type="button" id="confirm-cancel-btn" class="w-full py-2 px-4 bg-gray-200 dark:bg-gray-600 rounded-lg">Cancelar</button>
                 <button type="button" id="confirm-delete-btn" class="w-full py-2 px-4 bg-red-600 text-white font-semibold rounded-lg">Eliminar</button>
             </div>
             <div id="confirm-deferred-buttons" class="hidden flex flex-col gap-3">
                <button type="button" id="delete-series-btn" class="w-full py-2 px-4 bg-red-700 text-white font-semibold rounded-lg">Eliminar este y futuros</button>
                <button type="button" id="delete-single-btn" class="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-lg">Eliminar solo este</button>
                <button type="button" id="delete-cancel-btn" class="w-full py-2 px-4 bg-gray-200 dark:bg-gray-600 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc, writeBatch, where, getDocs, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDsQ9zmianEZ9Ni55HobKNdLjuQeHtDCtQ",
            authDomain: "billetera-grande.firebaseapp.com",
            projectId: "billetera-grande",
            storageBucket: "billetera-grande.firebasestorage.app",
            messagingSenderId: "629388259757",
            appId: "1:629388259757:web:1bc0ecd74fd162db3bf124",
            measurementId: "G-8V5KCSW9YC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        // --- REFERENCIAS AL DOM ---
        const authScreen = document.getElementById('auth-screen');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const appScreen = document.getElementById('app-screen');
        const userInfoEl = document.getElementById('user-info');
        const signOutBtn = document.getElementById('sign-out-btn');
        const balanceEl = document.getElementById('balance');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const totalWeeklySuggestionEl = document.getElementById('total-weekly-suggestion');
        const weeklySuggestionWrapper = document.getElementById('weekly-suggestion-wrapper');
        const addTransactionBtn = document.getElementById('add-transaction-btn');
        const transactionsListEl = document.getElementById('transactions-list');
        const chartSection = document.getElementById('chart-section');
        const showExpensesBtn = document.getElementById('show-expenses-chart');
        const showIncomeBtn = document.getElementById('show-income-chart');
        
        // Cuentas
        const accountsListEl = document.getElementById('accounts-list');
        const addAccountBtn = document.getElementById('add-account-btn');
        const accountModal = document.getElementById('account-modal');
        const accountModalTitle = document.getElementById('account-modal-title');
        const accountForm = document.getElementById('account-form');
        const accountCancelBtn = document.getElementById('account-cancel-btn');
        const accountSubmitBtn = document.getElementById('account-submit-btn');
        const accountDeleteBtn = document.getElementById('account-delete-btn');
        const accountTypeSelect = document.getElementById('account-type');
        const extraFieldsSection = document.getElementById('extra-fields-section');
        const creditLimitWrapper = document.getElementById('credit-limit-wrapper');
        const loanFieldsWrapper = document.getElementById('loan-fields-wrapper');
        const cutOffDayWrapper = document.getElementById('cut-off-day-wrapper');
        const paymentDayWrapper = document.getElementById('payment-day-wrapper');


        // Transacciones
        const modal = document.getElementById('transaction-modal');
        const modalTitle = document.getElementById('modal-title');
        const cancelBtn = document.getElementById('cancel-btn');
        const transactionForm = document.getElementById('transaction-form');
        const submitBtn = document.getElementById('submit-btn');
        const categorySelect = document.getElementById('category');
        const accountSelect = document.getElementById('account');
        const deferSection = document.getElementById('defer-section');
        const deferExpenseCheckbox = document.getElementById('defer-expense-checkbox');
        const deferOptions = document.getElementById('defer-options');
        const editDateSection = document.getElementById('edit-date-section');

        // Confirmación
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmStandardButtons = document.getElementById('confirm-standard-buttons');
        const confirmDeferredButtons = document.getElementById('confirm-deferred-buttons');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteSeriesBtn = document.getElementById('delete-series-btn');
        const deleteSingleBtn = document.getElementById('delete-single-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');

        // --- ESTADO DE LA APLICACIÓN ---
        let currentUserId = null;
        let unsubscribeFromTransactions = null;
        let unsubscribeFromAccounts = null;
        let categoryChart = null; 
        let allTransactions = [];
        let allAccounts = [];
        let currentEditingId = null; 
        let itemToDelete = { id: null, type: null, transaction: null };

        const expenseCategories = { 'Comida': '🍔', 'Transporte': '🚗', 'Vivienda': '🏠', 'Cuentas y Pagos': '🧾', 'Entretenimiento': '🎬', 'Ropa': '👕', 'Salud': '❤️‍🩹', 'Educación': '📚', 'Mascotas': '🐾', 'Otros': '📦' };
        const incomeCategories = { 'Salario': '💼', 'Bonos': '💰', 'Inversiones': '📈', 'Regalos': '🎁', 'Otros': '🪙' };
        const accountIcons = { 'Efectivo': '💵', 'Débito': '💳', 'Crédito': '🏦', 'Ahorros': '💰', 'Préstamos': '🤝', 'Apartados': '📦' };

        // --- AUTENTICACIÓN ---
        const provider = new GoogleAuthProvider();

        const signInWithGoogle = () => {
            signInWithPopup(auth, provider).catch(error => console.error("Error al iniciar sesión con Google:", error));
        };

        const signOutUser = () => {
            signOut(auth).catch(error => console.error("Error al cerrar sesión:", error));
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userInfoEl.textContent = `Hola, ${user.displayName}`;
                authScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                listenToData(currentUserId);
            } else {
                currentUserId = null;
                appScreen.classList.add('hidden');
                authScreen.classList.remove('hidden');
                if(unsubscribeFromAccounts) unsubscribeFromAccounts();
                if(unsubscribeFromTransactions) unsubscribeFromTransactions();
                // Clear UI
                accountsListEl.innerHTML = '';
                transactionsListEl.innerHTML = '';
                balanceEl.textContent = '$0.00';
                totalIncomeEl.textContent = '$0.00';
                totalExpensesEl.textContent = '$0.00';
            }
        });

        // --- MANEJO DE DATOS (FIRESTORE) ---
        function listenToData(userId) {
            const getCollectionRef = (type) => collection(db, 'artifacts', appId, 'users', userId, type === 'account' ? 'accounts' : 'transactions');

            if (unsubscribeFromAccounts) unsubscribeFromAccounts();
            unsubscribeFromAccounts = onSnapshot(query(getCollectionRef('account')), (snapshot) => {
                allAccounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAccounts();
                updateAccountOptions();
            }, (error) => console.error("Error al obtener cuentas:", error));

            if (unsubscribeFromTransactions) unsubscribeFromTransactions();
            unsubscribeFromTransactions = onSnapshot(query(getCollectionRef('transaction')), (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allTransactions.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                renderTransactions();
                updateSummary();
                renderAccounts(); // Re-render accounts to update credit card balances
                updateChart(document.querySelector('#show-expenses-chart.bg-blue-600') ? 'expense' : 'income');
            }, (error) => console.error("Error al obtener transacciones:", error));
        }

        // --- FUNCIONES CRUD ---
        async function saveData(type, data, id = null) {
            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, type === 'account' ? 'accounts' : 'transactions');
            try {
                if (id) await updateDoc(doc(collectionRef, id), data);
                else return await addDoc(collectionRef, data);
            } catch (error) { console.error(`Error al guardar ${type}:`, error); }
        }

        async function deleteData(type, id) {
            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, type === 'account' ? 'accounts' : 'transactions');
            try { await deleteDoc(doc(collectionRef, id)); } 
            catch (error) { console.error(`Error al eliminar ${type}:`, error); }
        }

        function generateUUID() { // Fallback for crypto.randomUUID
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        async function addLoanScheduledPayments(accountData, accountId) {
            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'transactions');
            const batch = writeBatch(db);
            const monthlyPayment = accountData.initialLoanAmount / accountData.loanMonths;
            const loanPaymentGroupId = accountData.loanPaymentGroupId;
            let firstPaymentDate = new Date(accountData.startDate.toDate());
            firstPaymentDate.setDate(accountData.paymentDay);
            
            if (firstPaymentDate <= accountData.startDate.toDate()) {
                firstPaymentDate.setMonth(firstPaymentDate.getMonth() + 1);
            }

            for (let i = 0; i < accountData.loanMonths; i++) {
                const docRef = doc(collectionRef);
                let currentPaymentDate = new Date(firstPaymentDate.getTime());
                currentPaymentDate.setMonth(currentPaymentDate.getMonth() + i);

                const transactionDoc = {
                    accountId,
                    amount: monthlyPayment,
                    category: 'Cuentas y Pagos',
                    description: `${accountData.name} (Mes ${i + 1}/${accountData.loanMonths})`,
                    type: 'expense',
                    timestamp: Timestamp.fromDate(adjustForWeekend(currentPaymentDate)),
                    isScheduledPayment: true,
                    loanPaymentGroupId,
                };
                batch.set(docRef, transactionDoc);
            }
            try { await batch.commit(); }
            catch(error) { console.error("Error al guardar pagos programados:", error); }
        }

        async function handleDeferredTransaction(data, account) {
            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'transactions');
            const batch = writeBatch(db);
            const monthlyAmount = data.amount / data.deferMonths;
            const deferralGroupId = crypto.randomUUID ? crypto.randomUUID() : generateUUID();
            
            let firstPaymentDate;
            if (account.type === 'Crédito' && account.cutOffDay && account.paymentDay) {
                firstPaymentDate = calculatePaymentDate(new Date(), account);
            } else if (account.type === 'Préstamos' && account.paymentDay) {
                firstPaymentDate = getNextDate(account.paymentDay);
            } else {
                firstPaymentDate = new Date();
                firstPaymentDate.setMonth(firstPaymentDate.getMonth() + 1);
            }

            for (let i = 0; i < data.deferMonths; i++) {
                const docRef = doc(collectionRef);
                let currentPaymentDate = new Date(firstPaymentDate.getTime());
                currentPaymentDate.setMonth(currentPaymentDate.getMonth() + i);
                
                const transactionDoc = {
                    ...data, amount: monthlyAmount,
                    description: `${data.description} (Mes ${i + 1}/${data.deferMonths})`,
                    timestamp: Timestamp.fromDate(new Date()), // Keep purchase date
                    paymentDate: Timestamp.fromDate(adjustForWeekend(currentPaymentDate)),
                    isDeferred: true, deferralGroupId,
                    totalInstallments: data.deferMonths, currentInstallment: i + 1,
                    originalAmount: data.amount,
                };
                delete transactionDoc.deferMonths;
                batch.set(docRef, transactionDoc);
            }
            try { await batch.commit(); }
            catch(error) { console.error("Error al guardar gastos diferidos:", error); }
        }
        
        async function deleteTransactionSeries(transaction) {
            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'transactions');
            const groupId = transaction.deferralGroupId || transaction.loanPaymentGroupId;
            if (!groupId) return;
            const q = query(collectionRef, where(transaction.deferralGroupId ? 'deferralGroupId' : 'loanPaymentGroupId', '==', groupId));
            try {
                const batch = writeBatch(db);
                const querySnapshot = await getDocs(q);
                // Client-side filter to delete current and future installments
                querySnapshot.forEach(doc => {
                    const docData = doc.data();
                    if (docData.isDeferred && docData.currentInstallment >= transaction.currentInstallment) {
                        batch.delete(doc.ref);
                    } else if (docData.isScheduledPayment) {
                        const paymentDate = docData.timestamp.toDate();
                        const transactionDate = transaction.timestamp.toDate();
                        if(paymentDate >= transactionDate) {
                             batch.delete(doc.ref);
                        }
                    }
                });
                await batch.commit();
            } catch(error) { console.error("Error al eliminar serie:", error); }
        }

        // --- LÓGICA DE FECHAS ---
        function adjustForWeekend(date) {
            const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
            if (dayOfWeek === 6) { // It's a Saturday, move to Monday
                date.setDate(date.getDate() + 2);
            } else if (dayOfWeek === 0) { // It's a Sunday, move to Monday
                date.setDate(date.getDate() + 1);
            }
            return date;
        }

        function calculatePaymentDate(purchaseDate, account) {
            const { cutOffDay, paymentDay } = account;
            let paymentDueDate = new Date(purchaseDate);

            if (account.type === 'Crédito' && cutOffDay > paymentDay) {
                if (purchaseDate.getDate() <= cutOffDay) {
                    paymentDueDate.setMonth(paymentDueDate.getMonth() + 1, paymentDay);
                } else {
                    paymentDueDate.setMonth(paymentDueDate.getMonth() + 2, paymentDay);
                }
            } 
            else {
                if (purchaseDate.getDate() <= (cutOffDay || purchaseDate.getDate())) {
                     paymentDueDate.setDate(paymentDay);
                     if (paymentDueDate < purchaseDate) {
                        paymentDueDate.setMonth(paymentDueDate.getMonth() + 1);
                     }
                } else {
                    paymentDueDate.setMonth(paymentDueDate.getMonth() + 1, paymentDay);
                }
            }
            return adjustForWeekend(paymentDueDate);
        }

        function getNextDate(dayOfMonth) {
            const today = new Date();
            let nextDate = new Date(today.getFullYear(), today.getMonth(), dayOfMonth);
            if (nextDate < today) {
                nextDate.setMonth(nextDate.getMonth() + 1);
            }
            return nextDate;
        }
        
        function countFridays(startDate, endDate) {
            let count = 0;
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                if (currentDate.getDay() === 5) { // 5 is Friday
                    count++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return count > 0 ? count : 1; // Avoid division by zero
        }


        // --- RENDERIZADO Y UI ---
        const currencyFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
        const dateFormatter = new Intl.DateTimeFormat('es-ES', { day: '2-digit', month: 'short' });

        function renderAccounts() {
            accountsListEl.innerHTML = '';
            let totalWeeklySuggestion = 0;

            if (allAccounts.length === 0) {
                accountsListEl.innerHTML = `<p id="no-accounts" class="col-span-full text-center text-gray-500 dark:text-gray-400 py-4">Crea tu primera cuenta.</p>`;
            } else {
                allAccounts.forEach(acc => {
                    const accEl = document.createElement('button');
                    accEl.className = 'edit-account-btn bg-white dark:bg-gray-800 p-3 rounded-lg shadow text-left w-full hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
                    accEl.dataset.id = acc.id;

                    let content = '';

                    if (['Efectivo', 'Débito', 'Ahorros', 'Apartados'].includes(acc.type)) {
                        const incomes = allTransactions.filter(tx => tx.accountId === acc.id && tx.type === 'income').reduce((sum, tx) => sum + tx.amount, 0);
                        const expenses = allTransactions.filter(tx => tx.accountId === acc.id && tx.type === 'expense').reduce((sum, tx) => sum + tx.amount, 0);
                        const balance = incomes - expenses;
                        content = `<div class="flex items-center justify-between w-full">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${accountIcons[acc.type] || '❔'}</span>
                                <span class="font-semibold text-gray-700 dark:text-gray-200">${acc.name}</span>
                            </div>
                            <span class="font-bold text-lg text-gray-800 dark:text-white">${currencyFormatter.format(balance)}</span>
                        </div>`;
                    } else if (acc.type === 'Crédito' && acc.creditLimit) {
                        const expenses = allTransactions.filter(tx => tx.accountId === acc.id && tx.type === 'expense').reduce((sum, tx) => sum + tx.amount, 0);
                        const payments = allTransactions.filter(tx => tx.accountId === acc.id && tx.type === 'income').reduce((sum, tx) => sum + tx.amount, 0);
                        const spent = expenses - payments;
                        const available = acc.creditLimit - spent;
                        const usagePercentage = (spent / acc.creditLimit) * 100;
                        let periodDueHtml = '';
                        let nextEventHtml = '';
                        let weeklySuggestionHtml = '';


                        if (acc.cutOffDay && acc.paymentDay) {
                            const today = new Date();
                            let lastCutOff = getNextDate(acc.cutOffDay);
                            if(lastCutOff > today) lastCutOff.setMonth(lastCutOff.getMonth() -1);
                            
                            let previousCutOff = new Date(lastCutOff);
                            previousCutOff.setMonth(previousCutOff.getMonth() - 1);
                            
                            let paymentDateForPeriod = calculatePaymentDate(lastCutOff, acc);
                            
                            if (today > lastCutOff && today <= paymentDateForPeriod) {
                                const amountDue = allTransactions.filter(tx => {
                                    if(!tx.paymentDate) return false;
                                    const txPaymentDate = tx.paymentDate.toDate();
                                    return tx.accountId === acc.id && tx.type === 'expense' &&
                                        txPaymentDate.getTime() === paymentDateForPeriod.getTime();
                                }).reduce((sum, tx) => sum + tx.amount, 0);

                                const paymentsInWindow = allTransactions.filter(tx => {
                                     if(!tx.timestamp) return false;
                                    const txDate = tx.timestamp.toDate();
                                    return tx.accountId === acc.id && tx.type === 'income' && txDate > lastCutOff && txDate <= paymentDateForPeriod;
                                }).reduce((sum, tx) => sum + tx.amount, 0);

                                const finalAmountDue = amountDue - paymentsInWindow;

                                if (finalAmountDue > 0) {
                                    periodDueHtml = `<div class="flex items-center gap-1 text-xs text-amber-600 dark:text-amber-400 mt-2 font-semibold">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.5 2.75a.75.75 0 00-1.5 0v14.5a.75.75 0 001.5 0V15a.75.75 0 011.5 0v1.25a.75.75 0 001.5 0V15a.75.75 0 011.5 0v1.25a.75.75 0 001.5 0V15a.75.75 0 011.5 0v1.25a.75.75 0 001.5 0V2.75a.75.75 0 00-1.5 0V4a.75.75 0 01-1.5 0V2.75a.75.75 0 00-1.5 0V4a.75.75 0 01-1.5 0V2.75a.75.75 0 00-1.5 0V4a.75.75 0 01-1.5 0V2.75z" /><path d="M15.25 18a.75.75 0 001.5 0V2.75a.75.75 0 00-1.5 0V18z" /></svg>
                                        <span>Pago del Periodo: ${currencyFormatter.format(finalAmountDue)}</span></div>`;
                                    
                                    const fridaysLeft = countFridays(today, paymentDateForPeriod);
                                    const weeklySuggestion = finalAmountDue / fridaysLeft;
                                    totalWeeklySuggestion += weeklySuggestion;
                                    weeklySuggestionHtml = `<div class="flex items-center gap-1 text-xs text-green-600 dark:text-green-400 mt-1">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5a.75.75 0 000 1.5h10.5a.75.75 0 000-1.5H4.75z" clip-rule="evenodd" /></svg>
                                        <span>Sugerido Semanal: ${currencyFormatter.format(weeklySuggestion)}</span>
                                    </div>`;
                                }
                            }
                            
                            const nextCutOff = getNextDate(acc.cutOffDay);
                            const nextPayment = getNextDate(acc.paymentDay);
                            const nextEventDate = nextCutOff < nextPayment ? nextCutOff : nextPayment;
                            const nextEventLabel = nextCutOff < nextPayment ? 'Próx. Corte' : 'Próx. Pago';
                            
                            nextEventHtml = `<div class="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                                    <span>${nextEventLabel}: <span class="font-semibold text-gray-700 dark:text-gray-300">${dateFormatter.format(nextEventDate)}</span></span></div>`;
                        }

                        content = `<div>
                            <div class="flex items-center gap-2"><span class="text-lg">${accountIcons[acc.type] || '❔'}</span><span class="font-semibold text-gray-700 dark:text-gray-200">${acc.name}</span></div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700 my-2"><div class="bg-blue-600 h-1.5 rounded-full" style="width: ${usagePercentage}%"></div></div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Disponible: <span class="font-semibold text-gray-700 dark:text-gray-300">${currencyFormatter.format(available)}</span> de ${currencyFormatter.format(acc.creditLimit)}</div>
                            ${periodDueHtml} ${weeklySuggestionHtml} ${nextEventHtml}
                        </div>`;
                    } else if (acc.type === 'Préstamos' && acc.initialLoanAmount) {
                        const paymentsMade = allTransactions.filter(tx => tx.accountId === acc.id && tx.type === 'income').reduce((sum, tx) => sum + tx.amount, 0);
                        const remainingDebt = acc.initialLoanAmount - paymentsMade;
                        const paidPercentage = (paymentsMade / acc.initialLoanAmount) * 100;
                        let nextEventHtml = '';
                        let monthsPaidHtml = '';
                        let periodDueHtml = '';
                        let weeklySuggestionHtml = '';

                        if (acc.loanMonths) {
                            const monthlyPayment = acc.initialLoanAmount / acc.loanMonths;
                            const monthsPaid = Math.floor(paymentsMade / monthlyPayment);
                            monthsPaidHtml = `<div class="text-xs text-gray-500 dark:text-gray-400">Pagado: <span class="font-semibold text-gray-700 dark:text-gray-300">${monthsPaid} de ${acc.loanMonths} meses</span></div>`;
                            
                             if (acc.paymentDay) {
                                const today = new Date();
                                const nextPayment = getNextDate(acc.paymentDay);
                                let previousPayment = new Date(nextPayment);
                                previousPayment.setMonth(previousPayment.getMonth() - 1);

                                if (today >= previousPayment && today <= nextPayment) {
                                     periodDueHtml = `<div class="flex items-center gap-1 text-xs text-amber-600 dark:text-amber-400 mt-2 font-semibold">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.5 2.75a.75.75 0 00-1.5 0v14.5a.75.75 0 001.5 0V15a.75.75 0 011.5 0v1.25a.75.75 0 001.5 0V15a.75.75 0 011.5 0v1.25a.75.75 0 001.5 0V15a.75.75 0 011.5 0v1.25a.75.75 0 001.5 0V2.75a.75.75 0 00-1.5 0V4a.75.75 0 01-1.5 0V2.75a.75.75 0 00-1.5 0V4a.75.75 0 01-1.5 0V2.75a.75.75 0 00-1.5 0V4a.75.75 0 01-1.5 0V2.75z" /><path d="M15.25 18a.75.75 0 001.5 0V2.75a.75.75 0 00-1.5 0V18z" /></svg>
                                        <span>Pago del Periodo: ${currencyFormatter.format(monthlyPayment)}</span></div>`;
                                    
                                    const fridaysLeft = countFridays(today, nextPayment);
                                    const weeklySuggestion = monthlyPayment / fridaysLeft;
                                    totalWeeklySuggestion += weeklySuggestion;
                                    weeklySuggestionHtml = `<div class="flex items-center gap-1 text-xs text-green-600 dark:text-green-400 mt-1">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5a.75.75 0 000 1.5h10.5a.75.75 0 000-1.5H4.75z" clip-rule="evenodd" /></svg>
                                        <span>Sugerido Semanal: ${currencyFormatter.format(weeklySuggestion)}</span>
                                    </div>`;
                                }
                            }
                        }

                        if (acc.paymentDay) {
                            const nextPayment = getNextDate(acc.paymentDay);
                            nextEventHtml = `<div class="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400 mt-2">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                                <span>Próximo Pago: <span class="font-semibold text-gray-700 dark:text-gray-300">${dateFormatter.format(nextPayment)}</span></span>
                            </div>`;
                        }
                        
                        content = `<div>
                            <div class="flex items-center gap-2"><span class="text-lg">${accountIcons[acc.type] || '❔'}</span><span class="font-semibold text-gray-700 dark:text-gray-200">${acc.name}</span></div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700 my-2"><div class="bg-green-500 h-1.5 rounded-full" style="width: ${paidPercentage}%"></div></div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Resta: <span class="font-semibold text-gray-700 dark:text-gray-300">${currencyFormatter.format(remainingDebt)}</span> de ${currencyFormatter.format(acc.initialLoanAmount)}</div>
                            ${monthsPaidHtml}
                            ${periodDueHtml}
                            ${weeklySuggestionHtml}
                            ${nextEventHtml}
                        </div>`;
                    } else {
                        content = `<div class="flex items-center gap-2">
                            <span class="text-lg">${accountIcons[acc.type] || '❔'}</span> 
                            <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">${acc.name}</span>
                        </div>`;
                    }
                    accEl.innerHTML = content;
                    accountsListEl.appendChild(accEl);
                });
            }
            if(totalWeeklySuggestion > 0) {
                totalWeeklySuggestionEl.textContent = currencyFormatter.format(totalWeeklySuggestion);
                weeklySuggestionWrapper.classList.remove('hidden');
            } else {
                weeklySuggestionWrapper.classList.add('hidden');
            }
        }

        function renderTransactions() {
            transactionsListEl.innerHTML = '';
            if (allTransactions.length === 0) {
                transactionsListEl.innerHTML = `<p id="no-transactions" class="text-center text-gray-500 dark:text-gray-400 py-8">Aún no hay transacciones.</p>`;
                chartSection.classList.add('hidden');
            } else {
                if (allTransactions.some(tx => tx.type === 'expense')) chartSection.classList.remove('hidden');
                
                allTransactions.forEach(tx => {
                    const account = allAccounts.find(a => a.id === tx.accountId);
                    const isIncome = tx.type === 'income';
                    const date = tx.timestamp ? dateFormatter.format(tx.timestamp.toDate()) : '...';
                    const paymentDueDate = tx.paymentDate ? dateFormatter.format(tx.paymentDate.toDate()) : null;
                    const paymentDateHtml = paymentDueDate ? `
                        <span class="text-gray-400 dark:text-gray-500 text-xs">•</span>
                        <span class="flex items-center gap-1 text-xs text-blue-500 dark:text-blue-400">
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5a.75.75 0 000 1.5h10.5a.75.75 0 000-1.5H4.75z" clip-rule="evenodd" /></svg>
                            ${paymentDueDate}
                        </span>` : '';
                    
                    const isEditable = !tx.isDeferred;

                    const txEl = document.createElement('div');
                    txEl.className = `transaction-item flex items-center justify-between bg-white dark:bg-gray-800 p-4 rounded-xl shadow ${isEditable ? 'cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700' : 'opacity-70'} transition-colors`;
                    txEl.dataset.id = tx.id;

                    txEl.innerHTML = `
                        <div class="flex items-center gap-4 flex-grow pointer-events-none">
                             <div class="p-3 rounded-full text-xl ${isIncome ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'}">${expenseCategories[tx.category] || incomeCategories[tx.category] || '❔'}</div>
                             <div>
                                 <p class="font-semibold text-gray-800 dark:text-white">${tx.description}</p>
                                 <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                                     <span>${account?.name || 'S/C'}</span><span class="text-gray-400 dark:text-gray-500 text-xs">•</span><span>${date}</span>${paymentDateHtml}
                                 </div>
                             </div>
                        </div>
                        <div class="flex items-center gap-2">
                             <p class="font-bold text-lg ${isIncome ? 'text-green-500' : 'text-red-500'} text-right pointer-events-none">${isIncome ? '+' : '-'}${currencyFormatter.format(tx.amount)}</p>
                             <button data-id="${tx.id}" class="delete-transaction-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-red-500 relative z-10">
                                <svg class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>`;
                    transactionsListEl.appendChild(txEl);
                });
            }
        }

        function updateSummary() {
            const income = allTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = allTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            balanceEl.textContent = currencyFormatter.format(income - expenses);
            totalIncomeEl.textContent = currencyFormatter.format(income);
            totalExpensesEl.textContent = currencyFormatter.format(expenses);
        }

        function updateCategoryOptions(type = 'expense') {
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            categorySelect.innerHTML = '';
            Object.keys(categories).forEach(cat => categorySelect.add(new Option(`${categories[cat]} ${cat}`, cat)));
        }
        
        function updateAccountOptions() {
            accountSelect.innerHTML = '';
            if (allAccounts.length > 0) allAccounts.forEach(acc => accountSelect.add(new Option(`${accountIcons[acc.type] || '❔'} ${acc.name}`, acc.id)));
            else accountSelect.innerHTML = `<option disabled>Crea una cuenta primero</option>`;
            toggleDeferOptionVisibility();
        }
        
        // --- MANEJO DE MODALES ---
        function openModal(modalEl) {
            modalEl.classList.remove('hidden');
            setTimeout(() => {
                modalEl.querySelector('.modal-backdrop').classList.remove('opacity-0');
                modalEl.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function closeModal(modalEl) {
            modalEl.querySelector('.modal-backdrop').classList.add('opacity-0');
            modalEl.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modalEl.classList.add('hidden'), 300);
        }

        function setupTransactionModal(mode = 'add', transaction = null) {
            transactionForm.reset();
            deferSection.classList.add('hidden');
            deferOptions.classList.add('hidden');
            editDateSection.classList.add('hidden');

            if (mode === 'edit' && transaction) {
                currentEditingId = transaction.id;
                modalTitle.textContent = 'Editar Transacción'; 
                submitBtn.textContent = 'Actualizar';
                transactionForm.description.value = transaction.description;
                transactionForm.amount.value = transaction.amount;
                transactionForm.querySelector(`input[name="type"][value="${transaction.type}"]`).checked = true;
                updateCategoryOptions(transaction.type);
                categorySelect.value = transaction.category; 
                accountSelect.value = transaction.accountId;
                
                editDateSection.classList.remove('hidden');
                document.getElementById('transaction-date').value = transaction.timestamp.toDate().toISOString().split('T')[0];
            } else {
                currentEditingId = null;
                modalTitle.textContent = 'Nueva Transacción'; 
                submitBtn.textContent = 'Guardar';
                updateCategoryOptions();
            }
            toggleDeferOptionVisibility();
            openModal(modal);
        }
        
        function setupAccountModal(mode = 'add', account = null) {
            accountForm.reset();
            if (mode === 'edit' && account) {
                currentEditingId = account.id;
                accountModalTitle.textContent = 'Editar Cuenta';
                accountSubmitBtn.textContent = 'Actualizar';
                accountForm.accountName.value = account.name;
                accountForm.accountType.value = account.type;
                accountForm.creditLimit.value = account.creditLimit || '';
                accountForm.initialLoanAmount.value = account.initialLoanAmount || '';
                accountForm.loanMonths.value = account.loanMonths || '';
                accountForm.startDate.value = account.startDate?.toDate().toISOString().split('T')[0] || '';
                accountForm.cutOffDay.value = account.cutOffDay || '';
                accountForm.paymentDay.value = account.paymentDay || '';
                accountDeleteBtn.classList.remove('hidden');
            } else {
                currentEditingId = null;
                accountModalTitle.textContent = 'Nueva Cuenta';
                accountSubmitBtn.textContent = 'Guardar';
                accountDeleteBtn.classList.add('hidden');
            }
            toggleAccountFieldsVisibility();
            openModal(accountModal);
        }

        function openConfirmModal(id, type) {
            const transaction = allTransactions.find(t => t.id === id);
            itemToDelete = { id, type, transaction };
            
            if(type === 'transaction' && (transaction?.isDeferred || transaction?.isScheduledPayment)) {
                confirmTitle.textContent = 'Eliminar Transacción Programada';
                confirmMessage.textContent = 'Esta transacción es parte de una serie. ¿Cómo te gustaría proceder?';
                confirmStandardButtons.classList.add('hidden');
                confirmDeferredButtons.classList.remove('hidden');
            } else {
                confirmTitle.textContent = 'Confirmar Eliminación';
                confirmMessage.textContent = `¿Estás seguro de que quieres eliminar est${type === 'account' ? 'a cuenta' : 'a transacción'}? Esta acción no se puede deshacer.`;
                confirmStandardButtons.classList.remove('hidden');
                confirmDeferredButtons.classList.add('hidden');
            }
            openModal(confirmModal);
        }
        
        function toggleAccountFieldsVisibility() {
            const accountType = accountTypeSelect.value;
            const isCredit = accountType === 'Crédito';
            const isLoan = accountType === 'Préstamos';

            extraFieldsSection.classList.toggle('hidden', !isCredit && !isLoan);
            creditLimitWrapper.classList.toggle('hidden', !isCredit);
            loanFieldsWrapper.classList.toggle('hidden', !isLoan);
            cutOffDayWrapper.classList.toggle('hidden', !isCredit);
            paymentDayWrapper.classList.toggle('hidden', !isCredit && !isLoan);
        }

        function toggleDeferOptionVisibility() {
            const account = allAccounts.find(acc => acc.id === accountSelect.value);
            const isExpense = transactionForm.querySelector('input[name="type"]:checked').value === 'expense';
            const show = account && (account.type === 'Crédito' || account.type === 'Préstamos') && isExpense;
            deferSection.classList.toggle('hidden', !show);
            if (!show) {
                deferExpenseCheckbox.checked = false;
                deferOptions.classList.add('hidden');
            }
        }
        
        // --- EVENT LISTENERS ---
        googleLoginBtn.addEventListener('click', signInWithGoogle);
        signOutBtn.addEventListener('click', signOutUser);
        addTransactionBtn.addEventListener('click', () => setupTransactionModal('add'));
        addAccountBtn.addEventListener('click', () => setupAccountModal('add'));
        cancelBtn.addEventListener('click', () => closeModal(modal));
        accountCancelBtn.addEventListener('click', () => closeModal(accountModal));
        [confirmCancelBtn, deleteCancelBtn].forEach(btn => btn.addEventListener('click', () => closeModal(confirmModal)));
        accountTypeSelect.addEventListener('change', toggleAccountFieldsVisibility);
        transactionForm.querySelectorAll('input[name="type"]').forEach(radio => radio.addEventListener('change', toggleDeferOptionVisibility));
        accountSelect.addEventListener('change', toggleDeferOptionVisibility);
        deferExpenseCheckbox.addEventListener('change', () => deferOptions.classList.toggle('hidden', !deferExpenseCheckbox.checked));

        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId || allAccounts.length === 0) return;
            const formData = new FormData(transactionForm);
            const account = allAccounts.find(acc => acc.id === formData.get('account'));
            const data = {
                description: formData.get('description'), amount: parseFloat(formData.get('amount')),
                type: formData.get('type'), category: formData.get('category'),
                accountId: account.id
            };

            if (currentEditingId && formData.get('transactionDate')) {
                 data.timestamp = Timestamp.fromDate(new Date(formData.get('transactionDate') + 'T00:00:00'));
            } else if (!currentEditingId) {
                 data.timestamp = serverTimestamp();
            }

            if (data.type === 'expense' && (account.type === 'Crédito' || account.type === 'Préstamos') && deferExpenseCheckbox.checked) {
                data.deferMonths = parseInt(formData.get('deferMonths'));
                await handleDeferredTransaction(data, account);
            } else {
                if (data.type === 'expense' && account.type === 'Crédito' && account.cutOffDay && account.paymentDay) {
                    data.paymentDate = Timestamp.fromDate(calculatePaymentDate(new Date(), account));
                }
                await saveData('transaction', data, currentEditingId);
            }
            
            currentEditingId = null;
            closeModal(modal);
        });
        
        accountForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            const formData = new FormData(accountForm);
            const data = { name: formData.get('accountName'), type: formData.get('accountType') };
            
            if (data.type === 'Crédito') {
                data.creditLimit = parseFloat(formData.get('creditLimit')) || null;
                data.cutOffDay = parseInt(formData.get('cutOffDay')) || null;
                data.paymentDay = parseInt(formData.get('paymentDay')) || null;
            } else if (data.type === 'Préstamos') {
                data.initialLoanAmount = parseFloat(formData.get('initialLoanAmount')) || null;
                data.loanMonths = parseInt(formData.get('loanMonths')) || null;
                data.paymentDay = parseInt(formData.get('paymentDay')) || null;
                data.startDate = formData.get('startDate') ? Timestamp.fromDate(new Date(formData.get('startDate') + 'T00:00:00')) : null;
            }

            if (!currentEditingId) {
                data.createdAt = serverTimestamp();
                if(data.type === 'Préstamos' && data.initialLoanAmount && data.loanMonths && data.paymentDay) {
                    data.loanPaymentGroupId = generateUUID();
                    const newAccountRef = await saveData('account', data);
                    await addLoanScheduledPayments(data, newAccountRef.id);
                } else {
                    await saveData('account', data);
                }
            } else {
                await saveData('account', data, currentEditingId);
            }
            
            currentEditingId = null;
            closeModal(accountModal);
        });

        transactionsListEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-transaction-btn');
            if (deleteButton) {
                openConfirmModal(deleteButton.dataset.id, 'transaction');
                return;
            }
        
            const transactionItem = e.target.closest('.transaction-item');
            if (transactionItem) {
                const transactionId = transactionItem.dataset.id;
                const txToEdit = allTransactions.find(tx => tx.id === transactionId);
                
                if (txToEdit && !txToEdit.isDeferred) {
                    setupTransactionModal('edit', txToEdit);
                }
            }
        });
        
        accountsListEl.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-account-btn');
            if(editButton) {
                const accToEdit = allAccounts.find(acc => acc.id === editButton.dataset.id);
                if (accToEdit) setupAccountModal('edit', accToEdit);
            }
        });
        
        accountDeleteBtn.addEventListener('click', () => {
            if (currentEditingId) {
                closeModal(accountModal);
                openConfirmModal(currentEditingId, 'account');
            }
        });
        
        confirmDeleteBtn.addEventListener('click', async () => {
            if (itemToDelete.id && itemToDelete.type) {
                if (itemToDelete.type === 'account') {
                    const accDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'accounts', itemToDelete.id);
                    const accDocSnap = await getDoc(accDocRef);
                    if (accDocSnap.exists()) {
                        const accData = accDocSnap.data();
                        if (accData.loanPaymentGroupId) { // It's a loan with scheduled payments
                            const batch = writeBatch(db);
                            const q = query(collection(db, 'artifacts', appId, 'users', currentUserId, 'transactions'), where('loanPaymentGroupId', '==', accData.loanPaymentGroupId));
                            const querySnapshot = await getDocs(q);
                            querySnapshot.forEach(doc => batch.delete(doc.ref));
                            batch.delete(accDocRef);
                            await batch.commit();
                        } else {
                            await deleteData('account', itemToDelete.id);
                        }
                    }
                } else {
                     await deleteData(itemToDelete.type, itemToDelete.id);
                }
                closeModal(confirmModal);
            }
        });
        
        deleteSingleBtn.addEventListener('click', async () => {
            if (itemToDelete.id) {
                await deleteData('transaction', itemToDelete.id);
                closeModal(confirmModal);
            }
        });
        
        deleteSeriesBtn.addEventListener('click', async () => {
            if (itemToDelete.transaction) {
                await deleteTransactionSeries(itemToDelete.transaction);
                closeModal(confirmModal);
            }
        });
        
        [showExpensesBtn, showIncomeBtn].forEach(btn => btn.addEventListener('click', (e) => {
             const type = e.currentTarget.id === 'show-expenses-chart' ? 'expense' : 'income';
             updateChart(type);
             showExpensesBtn.classList.toggle('bg-blue-600', type === 'expense');
             showExpensesBtn.classList.toggle('text-white', type === 'expense');
             showIncomeBtn.classList.toggle('bg-blue-600', type === 'income');
             showIncomeBtn.classList.toggle('text-white', type === 'income');
         }));
        
        // --- GRÁFICO ---
        function updateChart(type = 'expense') {
            const transactionsToDisplay = allTransactions.filter(tx => tx.type === type);
            const chartContainer = document.getElementById('chart-container');
            const noChartDataEl = document.getElementById('no-chart-data');
        
            if (transactionsToDisplay.length > 0) {
                chartSection.classList.remove('hidden');
                noChartDataEl.classList.add('hidden');
            } else {
                if (categoryChart) { categoryChart.destroy(); categoryChart = null; }
                chartSection.classList.add('hidden');
                return;
            }
        
            const categoryData = transactionsToDisplay.reduce((acc, tx) => {
                acc[tx.category] = (acc[tx.category] || 0) + tx.amount; return acc;
            }, {});
            
            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);
            const isDarkMode = document.documentElement.classList.contains('dark');
            const legendColor = isDarkMode ? '#D1D5DB' : '#4B5563';
            
            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Monto', data: data,
                    backgroundColor: ['#3B82F6', '#10B981', '#F97316', '#EF4444', '#8B5CF6', '#F59E0B', '#6366F1', '#EC4899', '#14B8A6', '#D946EF'],
                    borderColor: isDarkMode ? '#1F2937' : '#FFFFFF', borderWidth: 2, hoverOffset: 8
                }]
            };
        
            if (categoryChart) {
                categoryChart.data = chartData;
                categoryChart.options.plugins.legend.labels.color = legendColor;
                categoryChart.options.borderColor = isDarkMode ? '#1F2937' : '#FFFFFF';
                categoryChart.update();
            } else {
                const ctx = document.getElementById('category-chart').getContext('2d');
                categoryChart = new Chart(ctx, {
                    type: 'doughnut', data: chartData,
                    options: { 
                        responsive: true, maintainAspectRatio: false, 
                        plugins: { 
                            legend: { position: 'right', labels: { color: legendColor, boxWidth: 20, padding: 15, font: { size: 12, family: "'Inter', sans-serif" }}}, 
                            tooltip: { callbacks: { label: (c) => `${c.label || ''}: ${currencyFormatter.format(c.parsed)}` }}
                        }, 
                        cutout: '60%' 
                    }
                });
            }
        }
    </script>
</body>
</html>
