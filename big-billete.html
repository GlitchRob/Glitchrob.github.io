<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Billetera Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importar Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos personalizados y animaciones */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .transaction-item, #chart-container {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Clases para modo oscuro */
        .dark .dark\:bg-gray-900 { background-color: #111827; }
        .dark .dark\:bg-gray-800 { background-color: #1F2937; }
        .dark .dark\:bg-gray-700 { background-color: #374151; }
        .dark .dark\:text-white { color: #ffffff; }
        .dark .dark\:text-gray-300 { color: #D1D5DB; }
        .dark .dark\:border-gray-700 { border-color: #374151; }
        .dark .dark\:placeholder-gray-400::placeholder { color: #9CA3B0; }
        .dark .dark\:chart-legend-text { color: #D1D5DB; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

    <!-- Pantalla de Carga/Autenticaci√≥n -->
    <div id="auth-screen" class="flex flex-col items-center justify-center min-h-screen p-4 text-center">
        <svg class="w-16 h-16 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25-2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m12 0V9" />
        </svg>
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Mi Billetera Digital</h1>
        <p class="text-gray-600 dark:text-gray-300 mt-2 mb-8">Inicia sesi√≥n para administrar tus finanzas.</p>
        <button id="google-login-btn" class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-white font-semibold py-2 px-6 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.519-3.444-11.01-8.169l-6.571 4.819C9.656 40.663 16.318 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.599 36.372 48 30.651 48 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
            <span>Iniciar sesi√≥n con Google</span>
        </button>
    </div>

    <!-- Contenido Principal de la Aplicaci√≥n -->
    <div id="app-screen" class="hidden max-w-2xl mx-auto">
        <header class="p-4 sm:p-6 flex justify-between items-center">
            <div>
                 <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Resumen Financiero</h1>
                 <p id="user-info" class="text-sm text-gray-500 dark:text-gray-400 mt-1 truncate"></p>
            </div>
            <button id="sign-out-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                Cerrar Sesi√≥n
            </button>
        </header>

        <main class="px-4 sm:px-6 pb-24">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-300">Balance Actual</p>
                        <p id="balance" class="text-4xl font-bold text-gray-800 dark:text-white mt-1">$0.00</p>
                    </div>
                    <div id="weekly-suggestion-wrapper" class="text-right hidden">
                         <p class="text-sm text-gray-500 dark:text-gray-300">Sugerido Semanal</p>
                         <p id="total-weekly-suggestion" class="text-2xl font-bold text-green-500 mt-1">$0.00</p>
                    </div>
                </div>
                <div class="flex justify-between mt-4 text-sm pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div>
                        <p class="text-gray-500 dark:text-gray-300">Ingresos</p>
                        <p id="total-income" class="font-semibold text-green-500 text-lg">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-500 dark:text-gray-300">Egresos</p>
                        <p id="total-expenses" class="font-semibold text-red-500 text-lg">$0.00</p>
                    </div>
                </div>
            </div>
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Cuentas</h2>
                    <button id="add-account-btn" class="flex items-center gap-1 text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        <span>Nueva</span>
                    </button>
                </div>
                <div id="accounts-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <p id="no-accounts" class="col-span-full text-center text-gray-500 dark:text-gray-400 py-4">Crea tu primera cuenta para empezar.</p>
                </div>
            </div>
            <div id="chart-section" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-6 hidden">
                 <div class="flex justify-between items-center mb-4">
                     <h2 class="text-xl font-bold text-gray-800 dark:text-white">An√°lisis</h2>
                     <div class="flex rounded-lg bg-gray-100 dark:bg-gray-700 p-1">
                         <button id="show-expenses-chart" class="px-3 py-1 text-sm font-semibold rounded-md text-white bg-blue-600">Egresos</button>
                         <button id="show-income-chart" class="px-3 py-1 text-sm font-semibold rounded-md text-gray-600 dark:text-gray-300">Ingresos</button>
                     </div>
                 </div>
                 <div id="chart-container" class="relative h-64">
                     <canvas id="category-chart"></canvas>
                     <p id="no-chart-data" class="absolute inset-0 flex items-center justify-center text-gray-500 dark:text-gray-400 hidden">No hay datos para mostrar</p>
                 </div>
            </div>
            <div class="mb-4">
                <div id="filters-container" class="flex space-x-2 bg-gray-200 dark:bg-gray-800 rounded-lg p-1">
                    <button data-filter="past" class="filter-btn w-full text-sm font-semibold text-gray-600 dark:text-gray-300 py-2 rounded-md transition-colors">Anteriores</button>
                    <button data-filter="today" class="filter-btn w-full text-sm font-semibold py-2 rounded-md transition-colors bg-white dark:bg-gray-700 text-blue-600 dark:text-white shadow">Hoy</button>
                    <button data-filter="week" class="filter-btn w-full text-sm font-semibold text-gray-600 dark:text-gray-300 py-2 rounded-md transition-colors">Semana</button>
                    <button data-filter="month" class="filter-btn w-full text-sm font-semibold text-gray-600 dark:text-gray-300 py-2 rounded-md transition-colors">Mes</button>
                    <button data-filter="year" class="filter-btn w-full text-sm font-semibold text-gray-600 dark:text-gray-300 py-2 rounded-md transition-colors">A√±o</button>
                </div>
            </div>
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Transacciones</h2>
            <div id="transactions-list" class="space-y-3">
                <p id="no-transactions" class="text-center text-gray-500 dark:text-gray-400 py-8">No hay transacciones en este periodo.</p>
            </div>
        </main>
        <button id="add-transaction-btn" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-transform transform hover:scale-110">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
        </button>
    </div>

    <!-- Modal para Agregar/Editar Transacci√≥n -->
    <div id="transaction-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md mx-auto p-6 z-10 transform scale-95">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Nueva Transacci√≥n</h2>
            <form id="transaction-form">
                <div class="flex gap-4 mb-4">
                    <label class="flex-1">
                        <input type="radio" name="type" value="expense" class="sr-only peer" checked>
                        <div class="p-3 text-center rounded-lg border-2 border-gray-300 peer-checked:border-red-500 peer-checked:text-red-600 dark:peer-checked:text-red-400 dark:border-gray-600 dark:peer-checked:border-red-500 cursor-pointer">
                            <span class="font-semibold">Egreso</span>
                        </div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="type" value="income" class="sr-only peer">
                        <div class="p-3 text-center rounded-lg border-2 border-gray-300 peer-checked:border-green-500 peer-checked:text-green-600 dark:peer-checked:text-green-400 dark:border-gray-600 dark:peer-checked:border-green-500 cursor-pointer">
                            <span class="font-semibold">Ingreso</span>
                        </div>
                    </label>
                </div>
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descripci√≥n</label>
                    <input type="text" id="description" name="description" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Ej: Caf√©, Salario, Renta">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monto</label>
                        <input type="number" id="amount" name="amount" min="0.01" step="0.01" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="0.00">
                    </div>
                    <div>
                        <label for="account" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cuenta</label>
                        <select id="account" name="account" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></select>
                    </div>
                </div>
                 <div class="mb-4">
                    <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Categor√≠a</label>
                    <select id="category" name="category" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></select>
                </div>
                <div id="edit-date-section" class="hidden mb-4">
                     <label for="transaction-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha de Transacci√≥n</label>
                     <input type="date" id="transaction-date" name="transactionDate" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                </div>
                <div id="defer-section" class="hidden mb-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="defer-expense-checkbox" name="deferExpense" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Diferir gasto a meses</span>
                    </label>
                    <div id="defer-options" class="hidden mt-2">
                        <label for="defer-months" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">N√∫mero de meses</label>
                        <select id="defer-months" name="deferMonths" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                            <option value="3">3 Meses</option> <option value="6">6 Meses</option> <option value="9">9 Meses</option> <option value="12">12 Meses</option> <option value="18">18 Meses</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button type="button" id="cancel-btn" class="w-full py-3 px-4 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold rounded-lg">Cancelar</button>
                    <button type="submit" id="submit-btn" class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Agregar/Editar Cuenta -->
    <div id="account-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md mx-auto p-6 z-10 transform scale-95">
            <h2 id="account-modal-title" class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Nueva Cuenta</h2>
            <form id="account-form">
                <div class="mb-4">
                    <label for="account-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre</label>
                    <input type="text" id="account-name" name="accountName" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Ej: Banco Principal">
                </div>
                <div class="mb-4">
                     <label for="account-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo</label>
                     <select id="account-type" name="accountType" required class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                         <option value="Efectivo">üíµ Efectivo</option> <option value="D√©bito">üí≥ D√©bito</option> <option value="Cr√©dito">üè¶ Cr√©dito</option>
                         <option value="Ahorros">üí∞ Ahorros</option> <option value="Pr√©stamos">ü§ù Pr√©stamos</option> <option value="Apartados">üì¶ Apartados</option>
                     </select>
                </div>
                <div id="extra-fields-section" class="hidden space-y-4 mb-4">
                    <div id="credit-limit-wrapper" class="hidden">
                        <label for="account-credit-limit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">L√≠mite de Cr√©dito</label>
                        <input type="number" id="account-credit-limit" name="creditLimit" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="10000.00" min="0" step="0.01">
                    </div>
                    <div id="loan-fields-wrapper" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="account-loan-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monto Pr√©stamo</label>
                                <input type="number" id="account-loan-amount" name="initialLoanAmount" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="50000.00" min="0" step="0.01">
                            </div>
                            <div>
                                <label for="account-loan-months" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Meses a Pagar</label>
                                <input type="number" id="account-loan-months" name="loanMonths" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="12" min="1">
                            </div>
                        </div>
                        <div>
                             <label for="account-start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha de Inicio</label>
                             <input type="date" id="account-start-date" name="startDate" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div id="cut-off-day-wrapper" class="hidden">
                            <label for="account-cut-off-day" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">D√≠a de Corte</label>
                            <input type="number" id="account-cut-off-day" name="cutOffDay" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="1-31" min="1" max="31">
                        </div>
                         <div id="payment-day-wrapper" class="hidden">
                            <label for="account-payment-day" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">D√≠a de Pago</label>
                            <input type="number" id="account-payment-day" name="paymentDay" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="1-31" min="1" max="31">
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button type="button" id="account-delete-btn" class="hidden w-auto py-3 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Eliminar</button>
                    <button type="button" id="account-cancel-btn" class="flex-grow py-3 px-4 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold rounded-lg">Cancelar</button>
                    <button type="submit" id="account-submit-btn" class="flex-grow py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Eliminar -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm mx-auto p-6 z-10 transform scale-95">
             <h2 id="confirm-title" class="text-lg font-bold text-gray-800 dark:text-white">Confirmar Eliminaci√≥n</h2>
             <p id="confirm-message" class="text-sm text-gray-600 dark:text-gray-300 mt-2 mb-6">¬øEst√°s seguro?</p>
             <div id="confirm-standard-buttons" class="flex gap-4">
                 <button type="button" id="confirm-cancel-btn" class="w-full py-2 px-4 bg-gray-200 dark:bg-gray-600 rounded-lg">Cancelar</button>
                 <button type="button" id="confirm-delete-btn" class="w-full py-2 px-4 bg-red-600 text-white font-semibold rounded-lg">Eliminar</button>
             </div>
             <div id="confirm-deferred-buttons" class="hidden flex flex-col gap-3">
                <button type="button" id="delete-series-btn" class="w-full py-2 px-4 bg-red-700 text-white font-semibold rounded-lg">Eliminar este y futuros</button>
                <button type="button" id="delete-single-btn" class="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-lg">Eliminar solo este</button>
                <button type="button" id="delete-cancel-btn" class="w-full py-2 px-4 bg-gray-200 dark:bg-gray-600 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc, writeBatch, where, getDocs, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBH2uP3cOt17o-JW7g75rzRXsLe0J73Wcg",
            authDomain: "billetera-grande.firebaseapp.com",
            projectId: "billetera-grande",
            storageBucket: "billetera-grande.firebasestorage.app",
            messagingSenderId: "629388259757",
            appId: "1:629388259757:android:65bf998efee3336b3bf124",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        // --- REFERENCIAS AL DOM ---
        const authScreen = document.getElementById('auth-screen');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const appScreen = document.getElementById('app-screen');
        const userInfoEl = document.getElementById('user-info');
        const signOutBtn = document.getElementById('sign-out-btn');
        const balanceEl = document.getElementById('balance');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const totalWeeklySuggestionEl = document.getElementById('total-weekly-suggestion');
        const weeklySuggestionWrapper = document.getElementById('weekly-suggestion-wrapper');
        const addTransactionBtn = document.getElementById('add-transaction-btn');
        const transactionsListEl = document.getElementById('transactions-list');
        const chartSection = document.getElementById('chart-section');
        const showExpensesBtn = document.getElementById('show-expenses-chart');
        const showIncomeBtn = document.getElementById('show-income-chart');
        const accountsListEl = document.getElementById('accounts-list');
        const addAccountBtn = document.getElementById('add-account-btn');
        const accountModal = document.getElementById('account-modal');
        const accountModalTitle = document.getElementById('account-modal-title');
        const accountForm = document.getElementById('account-form');
        const accountCancelBtn = document.getElementById('account-cancel-btn');
        const accountSubmitBtn = document.getElementById('account-submit-btn');
        const accountDeleteBtn = document.getElementById('account-delete-btn');
        const accountTypeSelect = document.getElementById('account-type');
        const extraFieldsSection = document.getElementById('extra-fields-section');
        const creditLimitWrapper = document.getElementById('credit-limit-wrapper');
        const loanFieldsWrapper = document.getElementById('loan-fields-wrapper');
        const cutOffDayWrapper = document.getElementById('cut-off-day-wrapper');
        const paymentDayWrapper = document.getElementById('payment-day-wrapper');
        const modal = document.getElementById('transaction-modal');
        const modalTitle = document.getElementById('modal-title');
        const cancelBtn = document.getElementById('cancel-btn');
        const transactionForm = document.getElementById('transaction-form');
        const submitBtn = document.getElementById('submit-btn');
        const categorySelect = document.getElementById('category');
        const accountSelect = document.getElementById('account');
        const deferSection = document.getElementById('defer-section');
        const deferExpenseCheckbox = document.getElementById('defer-expense-checkbox');
        const deferOptions = document.getElementById('defer-options');
        const editDateSection = document.getElementById('edit-date-section');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmStandardButtons = document.getElementById('confirm-standard-buttons');
        const confirmDeferredButtons = document.getElementById('confirm-deferred-buttons');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteSeriesBtn = document.getElementById('delete-series-btn');
        const deleteSingleBtn = document.getElementById('delete-single-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        const filtersContainer = document.getElementById('filters-container');


        // --- ESTADO DE LA APLICACI√ìN ---
        let currentUserId = null;
        let unsubscribeFromTransactions = null;
        let unsubscribeFromAccounts = null;
        let categoryChart = null; 
        let allTransactions = [];
        let allAccounts = [];
        let currentEditingId = null; 
        let itemToDelete = { id: null, type: null, transaction: null };
        let currentFilter = 'today';

        const expenseCategories = { 'Comida': 'üçî', 'Transporte': 'üöó', 'Vivienda': 'üè†', 'Cuentas y Pagos': 'üßæ', 'Entretenimiento': 'üé¨', 'Ropa': 'üëï', 'Salud': '‚ù§Ô∏è‚Äçü©π', 'Educaci√≥n': 'üìö', 'Mascotas': 'üêæ', 'Otros': 'üì¶' };
        const incomeCategories = { 'Salario': 'üíº', 'Bonos': 'üí∞', 'Inversiones': 'üìà', 'Regalos': 'üéÅ', 'Otros': 'ü™ô' };
        const accountIcons = { 'Efectivo': 'üíµ', 'D√©bito': 'üí≥', 'Cr√©dito': 'üè¶', 'Ahorros': 'üí∞', 'Pr√©stamos': 'ü§ù', 'Apartados': 'üì¶' };

        // --- AUTENTICACI√ìN ---
        const provider = new GoogleAuthProvider();
        const signInWithGoogle = () => signInWithPopup(auth, provider).catch(error => console.error("Error al iniciar sesi√≥n con Google:", error));
        const signOutUser = () => signOut(auth).catch(error => console.error("Error al cerrar sesi√≥n:", error));
        
        window.signInFromNative = (customToken) => {
            if (customToken) {
                signInWithCustomToken(auth, customToken)
                    .catch(error => console.error("Error al iniciar sesi√≥n con token personalizado:", error));
            } else {
                console.error("La app nativa no proporcion√≥ un token.");
            }
        };

        const requestGoogleSignIn = () => {
            if (window.Android && typeof window.Android.requestGoogleSignIn === 'function') {
                window.Android.requestGoogleSignIn();
            } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.requestGoogleSignIn) {
                window.webkit.messageHandlers.requestGoogleSignIn.postMessage({});
            } else {
                console.log("Ejecutando en un navegador est√°ndar, usando pop-up.");
                signInWithGoogle();
            }
        };
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userInfoEl.textContent = `Hola, ${user.displayName}`;
                authScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                listenToData(currentUserId);
            } else {
                currentUserId = null;
                appScreen.classList.add('hidden');
                authScreen.classList.remove('hidden');
                if(unsubscribeFromAccounts) unsubscribeFromAccounts();
                if(unsubscribeFromTransactions) unsubscribeFromTransactions();
                accountsListEl.innerHTML = '';
                transactionsListEl.innerHTML = '';
                balanceEl.textContent = '$0.00';
                totalIncomeEl.textContent = '$0.00';
                totalExpensesEl.textContent = '$0.00';
            }
        });

        // --- MANEJO DE DATOS (FIRESTORE) ---
        function listenToData(userId) {
            const getCollectionRef = (type) => collection(db, 'artifacts', appId, 'users', userId, type === 'account' ? 'accounts' : 'transactions');

            if (unsubscribeFromAccounts) unsubscribeFromAccounts();
            unsubscribeFromAccounts = onSnapshot(query(getCollectionRef('account')), (snapshot) => {
                allAccounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDisplay();
            }, (error) => console.error("Error al obtener cuentas:", error));

            if (unsubscribeFromTransactions) unsubscribeFromTransactions();
            unsubscribeFromTransactions = onSnapshot(query(getCollectionRef('transaction')), (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allTransactions.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                updateDisplay();
            }, (error) => console.error("Error al obtener transacciones:", error));
        }
        
        // --- L√ìGICA DE FILTRADO Y ACTUALIZACI√ìN ---
        function filterTransactions(transactions, filter) {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000 - 1);

            switch (filter) {
                case 'today':
                    return transactions.filter(tx => {
                        if (!tx.timestamp) return false;
                        const txDate = tx.timestamp.toDate();
                        return txDate >= todayStart && txDate <= todayEnd;
                    });
                case 'past':
                    return transactions.filter(tx => tx.timestamp?.toDate() < todayStart);
                case 'week':
                    const weekStart = new Date(todayStart);
                    weekStart.setDate(weekStart.getDate() - now.getDay()); // Sunday
                    return transactions.filter(tx => tx.timestamp?.toDate() >= weekStart);
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    return transactions.filter(tx => tx.timestamp?.toDate() >= monthStart);
                case 'year':
                    const yearStart = new Date(now.getFullYear(), 0, 1);
                    return transactions.filter(tx => tx.timestamp?.toDate() >= yearStart);
                default:
                    return transactions;
            }
        }
        
        function updateDisplay() {
            const filteredTransactions = filterTransactions(allTransactions, currentFilter);
            renderTransactions(filteredTransactions);
            updateSummary(filteredTransactions);
            renderAccounts(); 
            updateAccountOptions();
            updateChart(filteredTransactions, showExpensesBtn.classList.contains('bg-blue-600') ? 'expense' : 'income');
        }

        // --- FUNCIONES CRUD ---
        async function saveData(type, data, id = null) {
            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, type === 'account' ? 'accounts' : 'transactions');
            try {
                if (id) await updateDoc(doc(collectionRef, id), data);
                else return await addDoc(collectionRef, data);
            } catch (error) { console.error(`Error al guardar ${type}:`, error); }
        }

        async function deleteData(type, id) {
            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, type === 'account' ? 'accounts' : 'transactions');
            try { await deleteDoc(doc(collectionRef, id)); } 
            catch (error) { console.error(`Error al eliminar ${type}:`, error); }
        }

        function generateUUID() { // Fallback for crypto.randomUUID
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        async function addLoanScheduledPayments(accountData, accountId) {
            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'transactions');
            const batch = writeBatch(db);
            const monthlyPayment = accountData.initialLoanAmount / accountData.loanMonths;
            const loanPaymentGroupId = accountData.loanPaymentGroupId;
            let firstPaymentDate = new Date(accountData.startDate.toDate());
            firstPaymentDate.setDate(accountData.paymentDay);
            
            if (firstPaymentDate <= accountData.startDate.toDate()) {
                firstPaymentDate.setMonth(firstPaymentDate.getMonth() + 1);
            }

            for (let i = 0; i < accountData.loanMonths; i++) {
                const docRef = doc(collectionRef);
                let currentPaymentDate = new Date(firstPaymentDate.getTime());
                currentPaymentDate.setMonth(currentPaymentDate.getMonth() + i);

                const transactionDoc = {
                    accountId,
                    amount: monthlyPayment,
                    category: 'Cuentas y Pagos',
                    description: `${accountData.name} (Mes ${i + 1}/${accountData.loanMonths})`,
                    type: 'expense',
                    timestamp: Timestamp.fromDate(adjustForWeekend(currentPaymentDate)),
                    isScheduledPayment: true,
                    loanPaymentGroupId,
                };
                batch.set(docRef, transactionDoc);
            }
            try { await batch.commit(); }
            catch(error) { console.error("Error al guardar pagos programados:", error); }
        }

        async function handleDeferredTransaction(data, account) {
            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'transactions');
            const batch = writeBatch(db);
            const monthlyAmount = data.amount / data.deferMonths;
            const deferralGroupId = crypto.randomUUID ? crypto.randomUUID() : generateUUID();
            
            let firstPaymentDate;
            if (account.type === 'Cr√©dito' && account.cutOffDay && account.paymentDay) {
                firstPaymentDate = calculatePaymentDate(new Date(), account);
            } else if (account.type === 'Pr√©stamos' && account.paymentDay) {
                firstPaymentDate = getNextDate(account.paymentDay);
            } else {
                firstPaymentDate = new Date();
                firstPaymentDate.setMonth(firstPaymentDate.getMonth() + 1);
            }

            for (let i = 0; i < data.deferMonths; i++) {
                const docRef = doc(collectionRef);
                let currentPaymentDate = new Date(firstPaymentDate.getTime());
                currentPaymentDate.setMonth(currentPaymentDate.getMonth() + i);
                
                const transactionDoc = {
                    ...data, amount: monthlyAmount,
                    description: `${data.description} (Mes ${i + 1}/${data.deferMonths})`,
                    timestamp: Timestamp.fromDate(new Date()), // Keep purchase date
                    paymentDate: Timestamp.fromDate(adjustForWeekend(currentPaymentDate)),
                    isDeferred: true, deferralGroupId,
                    totalInstallments: data.deferMonths, currentInstallment: i + 1,
                    originalAmount: data.amount,
                };
                delete transactionDoc.deferMonths;
                batch.set(docRef, transactionDoc);
            }
            try { await batch.commit(); }
            catch(error) { console.error("Error al guardar gastos diferidos:", error); }
        }
        
        async function deleteTransactionSeries(transaction) {
            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'transactions');
            const groupId = transaction.deferralGroupId || transaction.loanPaymentGroupId;
            if (!groupId) return;
            const q = query(collectionRef, where(transaction.deferralGroupId ? 'deferralGroupId' : 'loanPaymentGroupId', '==', groupId));
            try {
                const batch = writeBatch(db);
                const querySnapshot = await getDocs(q);
                // Client-side filter to delete current and future installments
                querySnapshot.forEach(doc => {
                    const docData = doc.data();
                    if (docData.isDeferred && docData.currentInstallment >= transaction.currentInstallment) {
                        batch.delete(doc.ref);
                    } else if (docData.isScheduledPayment) {
                        const paymentDate = docData.timestamp.toDate();
                        const transactionDate = transaction.timestamp.toDate();
                        if(paymentDate >= transactionDate) {
                             batch.delete(doc.ref);
                        }
                    }
                });
                await batch.commit();
            } catch(error) { console.error("Error al eliminar serie:", error); }
        }

        // --- L√ìGICA DE FECHAS ---
        function adjustForWeekend(date) {
            const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
            if (dayOfWeek === 6) { date.setDate(date.getDate() + 2); } 
            else if (dayOfWeek === 0) { date.setDate(date.getDate() + 1); }
            return date;
        }

        function calculatePaymentDate(purchaseDate, account) {
            const { cutOffDay, paymentDay } = account;
            let paymentDueDate = new Date(purchaseDate);
            if (cutOffDay > paymentDay) {
                if (purchaseDate.getDate() <= cutOffDay) {
                    paymentDueDate.setMonth(paymentDueDate.getMonth() + 1, paymentDay);
                } else {
                    paymentDueDate.setMonth(paymentDueDate.getMonth() + 2, paymentDay);
                }
            } 
            else {
                if (purchaseDate.getDate() <= cutOffDay) {
                    paymentDueDate.setDate(paymentDay);
                } else {
                    paymentDueDate.setMonth(paymentDueDate.getMonth() + 1, paymentDay);
                }
            }
            return adjustForWeekend(paymentDueDate);
        }

        function getNextDate(dayOfMonth) {
            const today = new Date();
            let nextDate = new Date(today.getFullYear(), today.getMonth(), dayOfMonth);
            if (nextDate < today) {
                nextDate.setMonth(nextDate.getMonth() + 1);
            }
            return nextDate;
        }
        
        function countFridays(startDate, endDate) {
            let count = 0;
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                if (currentDate.getDay() === 5) { // 5 is Friday
                    count++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return count > 0 ? count : 1; // Avoid division by zero
        }


        // --- RENDERIZADO Y UI ---
        const currencyFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
        const dateFormatter = new Intl.DateTimeFormat('es-ES', { day: '2-digit', month: 'short' });

        function renderAccounts() {
            // (Esta funci√≥n no necesita cambios, ya estaba completa)
        }
        function renderTransactions(transactionsToRender) {
            // (Esta funci√≥n no necesita cambios)
        }
        function updateSummary(transactions) {
            // (Esta funci√≥n no necesita cambios)
        }
        function updateCategoryOptions(type = 'expense') {
            // (Esta funci√≥n no necesita cambios)
        }
        function updateAccountOptions() {
             // (Esta funci√≥n no necesita cambios)
        }
        
        // --- MANEJO DE MODALES ---
        function openModal(modalEl) { /* ... */ }
        function closeModal(modalEl) { /* ... */ }
        function setupTransactionModal(mode = 'add', transaction = null) { /* ... */ }
        function setupAccountModal(mode = 'add', account = null) { /* ... */ }
        function openConfirmModal(id, type) { /* ... */ }
        function toggleAccountFieldsVisibility() { /* ... */ }
        function toggleDeferOptionVisibility() { /* ... */ }
        
        // --- EVENT LISTENERS ---
        googleLoginBtn.addEventListener('click', requestGoogleSignIn);
        signOutBtn.addEventListener('click', signOutUser);
        addTransactionBtn.addEventListener('click', () => setupTransactionModal('add'));
        addAccountBtn.addEventListener('click', () => setupAccountModal('add'));
        cancelBtn.addEventListener('click', () => closeModal(modal));
        accountCancelBtn.addEventListener('click', () => closeModal(accountModal));
        [confirmCancelBtn, deleteCancelBtn].forEach(btn => btn.addEventListener('click', () => closeModal(confirmModal)));
        accountTypeSelect.addEventListener('change', toggleAccountFieldsVisibility);
        transactionForm.querySelectorAll('input[name="type"]').forEach(radio => radio.addEventListener('change', toggleDeferOptionVisibility));
        accountSelect.addEventListener('change', toggleDeferOptionVisibility);
        deferExpenseCheckbox.addEventListener('change', () => deferOptions.classList.toggle('hidden', !deferExpenseCheckbox.checked));
        filtersContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.filter-btn');
            if (!button) return;
            currentFilter = button.dataset.filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'dark:bg-gray-700', 'text-blue-600', 'dark:text-white', 'shadow');
                btn.classList.add('text-gray-600', 'dark:text-gray-300');
            });
            button.classList.add('bg-white', 'dark:bg-gray-700', 'text-blue-600', 'dark:text-white', 'shadow');
            button.classList.remove('text-gray-600', 'dark:text-gray-300');
            updateDisplay();
        });
        transactionForm.addEventListener('submit', async (e) => { /* ... */ });
        accountForm.addEventListener('submit', async(e) => { /* ... */ });
        transactionsListEl.addEventListener('click', (e) => { /* ... */ });
        accountsListEl.addEventListener('click', (e) => { /* ... */ });
        accountDeleteBtn.addEventListener('click', () => { /* ... */ });
        confirmDeleteBtn.addEventListener('click', async () => { /* ... */ });
        deleteSingleBtn.addEventListener('click', async () => { /* ... */ });
        deleteSeriesBtn.addEventListener('click', async () => { /* ... */ });
        [showExpensesBtn, showIncomeBtn].forEach(btn => btn.addEventListener('click', (e) => { /* ... */ }));
        
        // --- GR√ÅFICO ---
        function updateChart(transactions, type) {
            const transactionsToDisplay = transactions.filter(tx => tx.type === type);
            // (El resto de la l√≥gica del gr√°fico no cambia)
        }
    </script>
</body>
</html>

