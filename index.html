<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Precios con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #reader {
            width: 100%;
            border-radius: 0.75rem;
            border: 2px solid #4f46e5;
            overflow: hidden;
            position: relative;
        }
        #reader.scanning::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
            animation: scanning 2s infinite linear;
        }
        @keyframes scanning {
            0% { transform: translateY(0); }
            50% { transform: translateY(calc(100% - 4px)); }
            100% { transform: translateY(0); }
        }
        #reader video { width: 100%; height: auto; display: block; }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl font-bold text-indigo-400">Comparador Inteligente ✨</h1>
            <p id="header-subtitle" class="text-gray-400 mt-2">Apunta la cámara al código de barras.</p>
        </header>

        <main id="scanner-section">
            <div id="reader" class="bg-gray-700"></div>
        </main>

        <section id="result-section" class="hidden space-y-4">
            <!-- Info básica del producto -->
            <div id="product-display" class="hidden text-center p-4 bg-gray-700 rounded-lg relative">
                <img id="product-image" src="" alt="Imagen del Producto" class="mx-auto my-2 rounded-lg w-28 h-28 object-contain bg-white p-1 shadow-md" onerror="this.src='https://placehold.co/128x128/ffffff/e0e0e0?text=Sin+Imagen'; this.onerror=null;">
                <button id="edit-image-button" class="absolute top-4 right-4 bg-black/50 p-1.5 rounded-full text-white hover:bg-black/75">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg>
                </button>
                <h3 id="product-name" class="text-xl font-bold text-white"></h3>
                <p id="product-barcode" class="text-sm font-mono text-gray-400"></p>
                <p id="product-category" class="text-xs text-purple-400 font-medium mt-1"></p>
                <p id="category-loader" class="hidden text-xs text-purple-400 animate-pulse">Identificando categoría con IA...</p>
            </div>
            
            <div id="image-edit-options" class="hidden p-4 bg-gray-700/80 rounded-lg space-y-3">
                 <h3 class="text-md font-semibold text-center text-gray-200">Actualizar Imagen</h3>
                 <input type="text" id="image-url-input" placeholder="Pegar URL de la imagen" class="block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                 <button id="upload-image-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Subir de Galería</button>
                 <input type="file" id="image-file-input" class="hidden" accept="image/*">
            </div>

            <div id="loading-spinner" class="hidden text-center">
                <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="text-yellow-400 mt-2">Buscando información del producto...</p>
            </div>
            <div id="not-found" class="hidden p-4 bg-red-900/50 rounded-lg text-center">
                <p class="text-xl text-red-300">Producto no encontrado online. Puedes agregarlo manualmente.</p>
            </div>

            <!-- Comparación de precios (mismo producto) -->
            <div id="price-comparison-section" class="hidden space-y-3">
                <h2 class="text-lg font-semibold text-center text-indigo-300">Precios de este Producto</h2>
                <ul id="price-list" class="space-y-2"></ul>
            </div>
            
            <!-- NUEVO: Comparación de productos similares -->
            <div id="similar-products-section" class="hidden space-y-3">
                <h2 class="text-lg font-semibold text-center text-green-300">Alternativas Similares</h2>
                <ul id="similar-products-list" class="space-y-2"></ul>
            </div>

            <!-- Formulario para agregar/actualizar precios -->
            <div id="add-price-form" class="hidden p-4 bg-gray-700/50 rounded-lg space-y-4">
                 <h2 id="form-title" class="text-lg font-semibold text-center text-indigo-300"></h2>
                <div id="manual-name-container" class="hidden">
                    <label for="manual-product-name" class="block text-sm font-medium text-gray-300">Nombre del Producto</label>
                    <div class="flex items-center gap-2 mt-1">
                        <input type="text" id="manual-product-name" placeholder="Ej: Café 250g" class="block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="suggest-name-button" class="flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg shrink-0 transition-all">
                            <span id="suggest-button-text">✨ Sugerir</span>
                            <div id="suggest-spinner" class="spinner hidden"></div>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="price-input" class="block text-sm font-medium text-gray-300">Precio (MXN)</label>
                    <input type="number" id="price-input" step="0.01" placeholder="Ej: 35.50" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="store-select" class="block text-sm font-medium text-gray-300">Tienda</label>
                    <select id="store-select" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <button id="save-price-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Guardar Precio</button>
            </div>

            <!-- Gestionar Tiendas -->
            <div id="add-store-section" class="p-4 bg-gray-700/50 rounded-lg space-y-3">
                 <h2 class="text-lg font-semibold text-center text-gray-300">Gestionar Tiendas</h2>
                 <div class="flex gap-2">
                    <input type="text" id="new-store-input" placeholder="Nombre de la nueva tienda" class="block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="add-store-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shrink-0">+</button>
                 </div>
            </div>
        </section>

        <footer class="flex justify-center">
            <button id="rescan-button" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Escanear Otro</button>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & DOM ---
            let stores = [], products = {}, currentBarcode = null, currentProductInfo = null, html5QrCode, isScanning = false;

            const dom = {
                scannerSection: document.getElementById('scanner-section'),
                reader: document.getElementById('reader'),
                resultSection: document.getElementById('result-section'),
                productDisplay: document.getElementById('product-display'),
                productImage: document.getElementById('product-image'),
                productName: document.getElementById('product-name'),
                productBarcode: document.getElementById('product-barcode'),
                productCategory: document.getElementById('product-category'),
                categoryLoader: document.getElementById('category-loader'),
                editImageButton: document.getElementById('edit-image-button'),
                imageEditOptions: document.getElementById('image-edit-options'),
                imageUrlInput: document.getElementById('image-url-input'),
                uploadImageButton: document.getElementById('upload-image-button'),
                imageFileInput: document.getElementById('image-file-input'),
                loadingSpinner: document.getElementById('loading-spinner'),
                notFound: document.getElementById('not-found'),
                priceComparisonSection: document.getElementById('price-comparison-section'),
                priceList: document.getElementById('price-list'),
                similarProductsSection: document.getElementById('similar-products-section'),
                similarProductsList: document.getElementById('similar-products-list'),
                addPriceForm: document.getElementById('add-price-form'),
                formTitle: document.getElementById('form-title'),
                manualNameContainer: document.getElementById('manual-name-container'),
                manualProductName: document.getElementById('manual-product-name'),
                suggestNameButton: document.getElementById('suggest-name-button'),
                suggestButtonText: document.getElementById('suggest-button-text'),
                suggestSpinner: document.getElementById('suggest-spinner'),
                priceInput: document.getElementById('price-input'),
                storeSelect: document.getElementById('store-select'),
                savePriceButton: document.getElementById('save-price-button'),
                newStoreInput: document.getElementById('new-store-input'),
                addStoreButton: document.getElementById('add-store-button'),
                rescanButton: document.getElementById('rescan-button'),
                headerSubtitle: document.getElementById('header-subtitle'),
            };

            // --- DATA PERSISTENCE ---
            const saveData = () => {
                localStorage.setItem('scanner_stores', JSON.stringify(stores));
                localStorage.setItem('scanner_products', JSON.stringify(products));
            };
            const loadData = () => {
                stores = JSON.parse(localStorage.getItem('scanner_stores')) || [];
                products = JSON.parse(localStorage.getItem('scanner_products')) || {};
            };

            // --- UI RENDERING ---
            const updateStoreSelect = () => {
                dom.storeSelect.innerHTML = '<option value="">Selecciona una tienda</option>';
                stores.forEach(store => dom.storeSelect.add(new Option(store, store)));
            };

            const renderPriceComparison = (barcode) => {
                const product = products[barcode];
                const prices = product?.prices || {};
                if (Object.keys(prices).length === 0) {
                    dom.priceComparisonSection.classList.add('hidden');
                    return;
                }
                dom.priceList.innerHTML = '';
                Object.entries(prices).sort(([, a], [, b]) => a - b).forEach(([store, price], index) => {
                    const isCheapest = index === 0;
                    const li = document.createElement('li');
                    li.className = `flex justify-between items-center p-3 rounded-lg ${isCheapest ? 'bg-green-500/20 border border-green-500' : 'bg-gray-700'}`;
                    li.innerHTML = `<span class="font-medium ${isCheapest ? 'text-green-300' : ''}">${store}</span> <span class="font-bold text-xl ${isCheapest ? 'text-green-300' : ''}">MXN ${Number(price).toFixed(2)}</span>`;
                    dom.priceList.appendChild(li);
                });
                dom.priceComparisonSection.classList.remove('hidden');
            };
            
            const getBestPrice = (prices) => {
                if (!prices || Object.keys(prices).length === 0) return null;
                const minPrice = Math.min(...Object.values(prices));
                return `MXN ${minPrice.toFixed(2)}`;
            };

            const renderSimilarProducts = (category, currentBarcode) => {
                if (!category) {
                    dom.similarProductsSection.classList.add('hidden');
                    return;
                }
                const similar = Object.entries(products).filter(([barcode, product]) => product.category === category && barcode !== currentBarcode);
                
                if (similar.length === 0) {
                    dom.similarProductsSection.classList.add('hidden');
                    return;
                }

                dom.similarProductsList.innerHTML = '';
                similar.forEach(([barcode, product]) => {
                    const bestPrice = getBestPrice(product.prices);
                    const li = document.createElement('li');
                    li.className = 'flex items-center gap-4 p-2 bg-gray-700 rounded-lg';
                    li.innerHTML = `
                        <img src="${product.imageUrl || 'https://placehold.co/64x64/ffffff/e0e0e0?text=?'}" class="w-16 h-16 object-contain rounded-md bg-white p-1">
                        <div class="flex-1">
                            <p class="font-semibold text-white">${product.name}</p>
                            <p class="text-xs text-gray-400">Mejor Precio</p>
                        </div>
                        <p class="text-lg font-bold text-green-300">${bestPrice || 'N/A'}</p>
                    `;
                    dom.similarProductsList.appendChild(li);
                });
                dom.similarProductsSection.classList.remove('hidden');
            };

            const showView = (view) => {
                dom.scannerSection.classList.toggle('hidden', view !== 'scanner');
                dom.resultSection.classList.toggle('hidden', view !== 'results');
                dom.rescanButton.classList.toggle('hidden', view === 'scanner');
                dom.headerSubtitle.textContent = view === 'scanner' ? "Apunta la cámara al código de barras." : `Código: ${currentBarcode}`;
            };

            const resetResultView = () => {
                ['productDisplay', 'loadingSpinner', 'notFound', 'priceComparisonSection', 'similarProductsSection', 'addPriceForm', 'manualNameContainer', 'imageEditOptions', 'categoryLoader'].forEach(id => dom[id].classList.add('hidden'));
                ['manualProductName', 'priceInput', 'storeSelect', 'imageUrlInput', 'imageFileInput', 'productCategory'].forEach(id => dom[id].value = '');
                 dom.productCategory.textContent = '';
            };

            // --- IMAGE HANDLING ---
            const updateProductImage = (barcode, imageUrl) => {
                if (products[barcode]) {
                    products[barcode].imageUrl = imageUrl;
                    saveData();
                } else if (currentProductInfo) {
                    currentProductInfo.imageUrl = imageUrl;
                }
                dom.productImage.src = imageUrl;
            };

            const handleImageFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        updateProductImage(currentBarcode, e.target.result);
                        dom.imageEditOptions.classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            // --- API & LOGIC ---
            const fetchProductInfo = async (barcode) => {
                dom.loadingSpinner.classList.remove('hidden');
                try {
                    const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                    if (!response.ok) return null;
                    const data = await response.json();
                    if (data.status === 1 && data.product?.product_name) {
                        return { name: data.product.product_name, imageUrl: data.product.image_url || null };
                    }
                    return null;
                } catch (error) {
                    console.error("API Error:", error);
                    return null;
                } finally {
                    dom.loadingSpinner.classList.add('hidden');
                }
            };
            
            // --- GEMINI API INTEGRATION ---
            const callGemini = async (systemPrompt, userQuery) => {
                 const apiKey = ""; // Canvas will provide this
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userQuery }] }],
                };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Gemini API request failed`);
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text;
            };

            const suggestNameWithAI = async (barcode) => {
                dom.suggestNameButton.disabled = true;
                dom.suggestSpinner.classList.remove('hidden');
                try {
                    const systemPrompt = "Actúa como un experto en catalogación de productos de supermercado en México. Tu única tarea es sugerir un nombre corto y descriptivo para un producto, basándote en su código de barras. Proporciona solo el nombre del producto, sin explicaciones.";
                    const suggestedName = await callGemini(systemPrompt, `El código de barras es: ${barcode}. Sugiere un nombre.`);
                    dom.manualProductName.value = suggestedName ? suggestedName.trim() : "No se pudo sugerir un nombre.";
                } catch (error) {
                    console.error("Gemini Name Suggestion Error:", error);
                    dom.manualProductName.value = "Error al sugerir.";
                } finally {
                    dom.suggestNameButton.disabled = false;
                    dom.suggestSpinner.classList.add('hidden');
                }
            };

            const getCategoryWithAI = async (productName) => {
                dom.categoryLoader.classList.remove('hidden');
                try {
                    const systemPrompt = "Eres un experto en clasificación de productos de supermercado. Dada una descripción de producto, proporciona una categoría corta y precisa en español (máximo 3 palabras). Ejemplos: 'Refresco de Cola', 'Café Soluble', 'Botana Salada', 'Pan de Caja Blanco'. Responde únicamente con el nombre de la categoría.";
                    const category = await callGemini(systemPrompt, `Producto: "${productName}"`);
                    return category ? category.trim() : null;
                } catch (error) {
                    console.error("Gemini Category Error:", error);
                    return null;
                } finally {
                    dom.categoryLoader.classList.add('hidden');
                }
            };

            const handleScannedBarcode = async (barcode) => {
                currentBarcode = barcode;
                stopScanning();
                resetResultView();
                showView('results');
                
                let product = products[barcode];
                if (product) {
                    currentProductInfo = product;
                    dom.productName.textContent = product.name;
                    dom.productImage.src = product.imageUrl || 'https://placehold.co/128x128/ffffff/e0e0e0?text=Sin+Imagen';
                    dom.productCategory.textContent = product.category || '';
                    dom.productBarcode.textContent = barcode;
                    dom.productDisplay.classList.remove('hidden');
                    renderPriceComparison(barcode);
                    renderSimilarProducts(product.category, barcode);
                    dom.formTitle.textContent = "Actualizar o Agregar Precio";
                    dom.addPriceForm.classList.remove('hidden');
                } else {
                    currentProductInfo = await fetchProductInfo(barcode) || { name: '', imageUrl: null, category: null };
                    
                    if (currentProductInfo.name) {
                        dom.productName.textContent = currentProductInfo.name;
                        dom.productImage.src = currentProductInfo.imageUrl || 'https://placehold.co/128x128/ffffff/e0e0e0?text=Sin+Imagen';
                        dom.formTitle.textContent = "Agregar Precio al Catálogo";
                        
                        // Get category for new product
                        currentProductInfo.category = await getCategoryWithAI(currentProductInfo.name);
                        if (currentProductInfo.category) {
                            dom.productCategory.textContent = currentProductInfo.category;
                            renderSimilarProducts(currentProductInfo.category, barcode);
                        }
                    } else {
                        dom.productName.textContent = "Producto Desconocido";
                        dom.productImage.src = 'https://placehold.co/128x128/ffffff/e0e0e0?text=Añadir+Foto';
                        dom.notFound.classList.remove('hidden');
                        dom.manualNameContainer.classList.remove('hidden');
                        dom.formTitle.textContent = "Agregar Producto Manualmente";
                    }
                    
                    dom.productBarcode.textContent = barcode;
                    dom.productDisplay.classList.remove('hidden');
                    dom.addPriceForm.classList.remove('hidden');
                }
            };

            const addStore = () => {
                const newStoreName = dom.newStoreInput.value.trim();
                if (newStoreName && !stores.includes(newStoreName)) {
                    stores.push(newStoreName);
                    saveData();
                    updateStoreSelect();
                    dom.newStoreInput.value = '';
                }
            };

            const savePrice = async () => {
                const price = parseFloat(dom.priceInput.value);
                const store = dom.storeSelect.value;

                if (!currentBarcode || !store || isNaN(price) || price <= 0) {
                    alert("Por favor, ingresa un precio válido y selecciona una tienda.");
                    return;
                }
                
                if (!products[currentBarcode]) {
                    const manualName = dom.manualProductName.value.trim();
                    const finalName = manualName || currentProductInfo.name;
                    if (!finalName) {
                        alert("Por favor, ingresa el nombre del producto.");
                        return;
                    }

                    // If category was not identified before (e.g., manual entry), try now.
                    if (!currentProductInfo.category && finalName) {
                         currentProductInfo.category = await getCategoryWithAI(finalName);
                         if (currentProductInfo.category) dom.productCategory.textContent = currentProductInfo.category;
                    }
                    
                    products[currentBarcode] = {
                        name: finalName,
                        imageUrl: currentProductInfo.imageUrl,
                        category: currentProductInfo.category,
                        prices: {},
                    };
                }

                products[currentBarcode].prices[store] = price;
                saveData();
                renderPriceComparison(currentBarcode);
                renderSimilarProducts(products[currentBarcode].category, currentBarcode);
                dom.priceInput.value = '';
                dom.storeSelect.value = '';
                dom.formTitle.textContent = "¡Precio Guardado!";
            };

            // --- SCANNER CONTROLS ---
            const onScanSuccess = (decodedText) => { if (isScanning) handleScannedBarcode(decodedText); };
            const startScanning = () => {
                showView('scanner');
                const config = { fps: 10, qrbox: { width: 250, height: 150 }, rememberLastUsedCamera: true };
                dom.reader.classList.add('scanning');
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                    .then(() => isScanning = true)
                    .catch(err => console.error("Camera start error:", err));
            };
            const stopScanning = () => {
                if (isScanning && html5QrCode.isScanning) {
                    dom.reader.classList.remove('scanning');
                    html5QrCode.stop().then(() => isScanning = false).catch(err => {});
                }
            };

            // --- INITIALIZATION ---
            const init = () => {
                loadData();
                updateStoreSelect();
                
                dom.addStoreButton.addEventListener('click', addStore);
                dom.savePriceButton.addEventListener('click', savePrice);
                dom.rescanButton.addEventListener('click', startScanning);
                dom.suggestNameButton.addEventListener('click', () => suggestNameWithAI(currentBarcode));
                dom.editImageButton.addEventListener('click', () => dom.imageEditOptions.classList.toggle('hidden'));
                dom.uploadImageButton.addEventListener('click', () => dom.imageFileInput.click());
                dom.imageFileInput.addEventListener('change', handleImageFileUpload);
                dom.imageUrlInput.addEventListener('change', (e) => {
                    const url = e.target.value.trim();
                    if (url) {
                        updateProductImage(currentBarcode, url);
                        e.target.value = '';
                        dom.imageEditOptions.classList.add('hidden');
                    }
                });

                html5QrCode = new Html5Qrcode("reader");
                startScanning();
            };

            init();
        });
    </script>
</body>
</html>

